<main class="dashboard" *ngIf="vm$ | async as vm">
  <section class="panel intro glass-panel">
    <div>
      <p class="eyebrow">Weather Data Integration Platform</p>
      <h1>Liquid Operations Deck</h1>
      <p class="subtitle">Track live weather, sync historical snapshots, and inspect multi-day forecasts in one cockpit.</p>
    </div>
    <button type="button" class="btn btn-strong action-button" (click)="refreshAll()" [disabled]="vm.loading">Refresh All</button>
  </section>

  <section class="panel metrics glass-panel" *ngIf="vm.preferences as prefs">
    <p><span>Tracked Cities</span><strong>{{ vm.locations.length }}</strong></p>
    <p><span>Units</span><strong>{{ prefs.units }}</strong></p>
    <p><span>Sync Interval</span><strong>{{ prefs.refreshIntervalMinutes }} min</strong></p>
  </section>

  <section class="panel country-forecasts glass-panel">
    <header>
      <h2>Country Forecasts</h2>
      <p class="hint">Click a country card to load its 5-day forecast, icons, and temperature trend.</p>
    </header>
    <div class="country-grid" *ngIf="vm.countryCards.length > 0; else noCountryCards">
      <article class="country-card" *ngFor="let card of vm.countryCards; trackBy: trackByCountry">
        <div class="country-header">
          <div>
            <h3>{{ card.country }}</h3>
            <p>{{ card.locationsCount }} tracked cities</p>
          </div>
          <button type="button" class="btn small ghost" (click)="toggleCountryForecast(card)" [disabled]="vm.loading || !card.locationId">
            {{ vm.expandedCountries[card.country] ? 'Hide forecast' : 'View 5-day forecast' }}
          </button>
        </div>

        <div class="country-body" *ngIf="vm.expandedCountries[card.country]">
          <p class="state-text" *ngIf="vm.countryForecastLoading[card.country]">Loading forecast...</p>
          <ng-container *ngIf="!vm.countryForecastLoading[card.country] && vm.countryForecasts[card.country] as state">
            <p class="state-text" *ngIf="state.forecast.days.length === 0">No forecast data available.</p>
            <div class="forecast-days" *ngIf="state.forecast.days.length > 0">
              <article class="forecast-day" *ngFor="let day of state.forecast.days">
                <p class="day-label">{{ formatDayLabel(day.dateUtc) }}</p>
                <img [src]="getIconUrl(day.iconCode)" [alt]="day.summary" />
                <p class="temp">{{ day.temperature | number: '1.0-1' }}&deg;{{ getTempUnit(state.forecast.units) }}</p>
                <p class="summary">{{ day.summary }}</p>
              </article>
            </div>

            <div class="forecast-chart" *ngIf="state.forecast.days.length > 0">
              <svg class="line-chart" [attr.viewBox]="'0 0 ' + state.chart.width + ' ' + state.chart.height" role="img" aria-label="5-day temperature trend">
                <g class="grid">
                  <line *ngFor="let grid of state.chart.gridLines" [attr.x1]="state.chart.padding" [attr.x2]="state.chart.width - state.chart.padding" [attr.y1]="grid.y" [attr.y2]="grid.y"></line>
                  <text *ngFor="let grid of state.chart.gridLines" class="y-label" [attr.x]="12" [attr.y]="grid.y + 4">{{ grid.label }}</text>
                </g>

                <g class="axis">
                  <line [attr.x1]="state.chart.padding" [attr.x2]="state.chart.width - state.chart.padding" [attr.y1]="state.chart.height - state.chart.padding" [attr.y2]="state.chart.height - state.chart.padding"></line>
                </g>

                <g class="series" *ngFor="let series of state.chart.series">
                  <polyline class="series-line" [attr.points]="series.points" [attr.stroke]="series.color"></polyline>
                  <circle *ngFor="let dot of series.dots" class="series-dot" [attr.cx]="dot.x" [attr.cy]="dot.y" [attr.r]="4" [attr.fill]="series.color"></circle>
                </g>

                <g class="x-axis">
                  <text *ngFor="let point of state.chart.xAxis" class="x-label" [attr.x]="point.x" [attr.y]="state.chart.height - state.chart.padding + 18">
                    {{ point.label }}
                  </text>
                </g>

                <text class="axis-title" [attr.x]="state.chart.width / 2" [attr.y]="state.chart.height - 6">Days</text>
                <text class="axis-title" [attr.x]="16" [attr.y]="state.chart.height / 2" [attr.transform]="'rotate(-90 16 ' + state.chart.height / 2 + ')'">
                  Temperature
                </text>
              </svg>

              <div class="legend">
                <div class="legend-item" *ngFor="let series of state.chart.series">
                  <span class="legend-swatch" [style.background]="series.color"></span>
                  <span>{{ series.label }}</span>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </article>
    </div>
    <ng-template #noCountryCards>
      <p class="hint">Add and sync locations to see country forecasts.</p>
    </ng-template>
  </section>

  <section class="panel grid two-col glass-panel">
    <article>
      <h2>Add Location</h2>
      <form [formGroup]="addCityForm" (ngSubmit)="addCity()" class="form-grid">
        <label>
          City
          <input class="control-surface" type="text" formControlName="city" placeholder="e.g. Harare" />
        </label>
        <label>
          Country code
          <input class="control-surface" type="text" formControlName="country" placeholder="e.g. ZW" />
        </label>
        <label class="checkbox">
          <input type="checkbox" formControlName="favorite" />
          Mark as favorite
        </label>
        <button type="submit" class="btn action-button" [disabled]="vm.loading">Add City</button>
      </form>
    </article>

    <article>
      <h2>Preferences</h2>
      <form [formGroup]="preferencesForm" (ngSubmit)="savePreferences()" class="form-grid">
        <label>
          Units
          <select class="control-surface" formControlName="units">
            <option value="metric">Metric</option>
            <option value="imperial">Imperial</option>
          </select>
        </label>
        <label>
          Refresh interval (minutes)
          <input class="control-surface" type="number" min="5" max="1440" formControlName="refreshIntervalMinutes" />
        </label>
        <p class="hint">Applies to background sync and dashboard weather rendering.</p>
        <button type="submit" class="btn action-button" [disabled]="vm.loading">Save Preferences</button>
      </form>
    </article>
  </section>

  <section class="error" *ngIf="vm.error">
    {{ vm.error }}
  </section>

  <section class="locations">
    <article class="location-card glass-panel" *ngFor="let location of vm.locations">
      <header>
        <div>
          <h3>{{ location.city }}, {{ location.country }}</h3>
          <p>Last sync: {{ formatTimestamp(location.lastSyncedAtUtc) }}</p>
        </div>
        <button type="button" class="icon-btn" (click)="toggleFavorite(location)" [attr.aria-label]="location.isFavorite ? 'Unset favorite' : 'Set favorite'">
          <span *ngIf="location.isFavorite">&#9733;</span>
          <span *ngIf="!location.isFavorite">&#9734;</span>
        </button>
      </header>

      <div class="current-weather" *ngIf="vm.weatherByLocation[location.id] as weather; else weatherMissing">
        <p class="temp">{{ weather.temperature | number: '1.0-1' }}&deg;{{ getTempUnit(weather.units) }}</p>
        <p class="summary">{{ weather.summary }}</p>
        <p>Feels like {{ weather.feelsLike | number: '1.0-1' }}&deg;{{ getTempUnit(weather.units) }}</p>
        <p>Humidity {{ weather.humidity }}% | Wind {{ weather.windSpeed | number: '1.0-1' }} {{ getWindUnit(weather.units) }}</p>
      </div>

      <ng-template #weatherMissing>
        <p class="hint">No weather snapshot available yet.</p>
      </ng-template>

      <footer>
        <button type="button" class="btn small action-button" (click)="refreshLocation(location.id)" [disabled]="vm.loading">Refresh</button>
        <a class="btn small ghost" [routerLink]="['/forecast', location.id]">Forecast</a>
        <button type="button" class="btn small danger" (click)="deleteLocation(location.id)" [disabled]="vm.loading">Remove</button>
      </footer>
    </article>
  </section>
</main>
